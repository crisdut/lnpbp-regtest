#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

# Set magic variables for current file & dir
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"
__base="$(basename ${__file} .sh)"

cd "$__dir/.."
source .env

if [[ $# -eq 1 ]]; then
    NODE="all"
    COMMAND="$1"
    ARGS="$@"
elif [[ $# -eq 2 ]]; then
    NODE="$1" && shift
    COMMAND="$1"
    ARGS="$@"
fi

L1_SET="bitcoin elecrs"
L2_SET="lnp-node"
L3_SET="rgb-node"

function setup_command() {
    bcli="docker-compose exec bitcoin bitcoin-cli -chain=regtest -rpcconnect=localhost -rpcport=${BITCOIN_RPC_PORT} -rpcuser=${BITCOIN_RPC_USER} -rpcpassword=${BITCOIN_RPC_PASSWORD}"
    
    lncli="docker-compose exec lnp-node lnpd --chain=testnet --port=${LNP_RPC_PORT} --electrum-port=${ELECTRS_PORT} --electrum-server=${ELECTRS_HOST} -vvvv"
    
    # libbitcoin
    seed=$(bx seed -b 256 | bx mnemonic-new)
    pk=$(bx seed -b 256 | bx mnemonic-new | bx mnemonic-to-seed | bx base16-decode | sha512sum - | cut -c 1-64)
    
    # Initialize L1 
    $bcli -named createwallet wallet_name='base' blank=true  
    $bcli -rpcwallet=base importprivkey $pk

    echo 'Your Seed: ' $seed
    echo 'Your PK: ' $pk

    # Initialize L2
    # get xprv here: https://iancoleman.io/bip39/#english
    lncli init -vvvv
    lncli -vvvv

    # Initialize L3
}

case "$COMMAND" in
    init) setup_command ;;
esac